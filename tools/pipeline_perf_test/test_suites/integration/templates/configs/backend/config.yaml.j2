settings:
  default_pipeline_ctrl_msg_channel_size: {{ default_pipeline_ctrl_msg_channel_size | default(100) }}
  default_node_ctrl_msg_channel_size: {{ default_node_ctrl_msg_channel_size | default(100) }}
  default_pdata_channel_size: {{ default_pdata_channel_size | default(100) }}

{%- set receiver_type = backend_receiver_type | default("otap") -%}
{%- set listen_addr = listening_addr | default("0.0.0.0:1235") -%}

{# Determine receiver type URN and config #}
{%- if receiver_type == "otap" -%}
  {% set type_urn = "urn:otel:otap:receiver" %}
  {% set compression = compression_method | default("zstd") %}
  {% set extra_config = {
    "response_stream_channel_size": 100,
    "compression_method": compression
  } %}
{%- elif receiver_type == "otlp" -%}
  {% set type_urn = "urn:otel:otlp:receiver" %}
  {% set compression = compression_method | default("gzip") %}
  {% set extra_config = {
    "request_compression": compression
  } %}
{%- else -%}
  {% set type_urn = "urn:unknown:invalid:receiver" %}
  {% set error_msg = "Unknown backend_receiver_type: " ~ receiver_type %}
{%- endif %}

nodes:
  receiver:
    type: "{{ type_urn }}"
    {%- if receiver_type in ["otap", "otlp"] %}
    config:
      {%- if receiver_type == "otlp" %}
      protocols:
        grpc:
          listening_addr: "{{ listen_addr }}"
          {%- for k, v in extra_config.items() %}
          {{ k }}: {{ v }}
          {%- endfor %}
      {%- else %}
      listening_addr: "{{ listen_addr }}"
      {%- for k, v in extra_config.items() %}
      {{ k }}: {{ v }}
      {%- endfor %}
      {%- endif %}
    {%- else %}
    config:
      error: "{{ error_msg }}"
    {%- endif %}

  perf:
    type: "urn:otel:perf:exporter"
    config:
      frequency: 500
      cpu_usage: false
      mem_usage: false
      disk_usage: false
      io_usage: false

connections:
  - from: receiver
    to: perf
