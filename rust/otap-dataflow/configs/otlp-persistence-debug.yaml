# OTLP → Persistence → Debug pipeline for testing
#
# This configuration lets you verify the persistence processor e2e flow
# by writing received data to a debug log file.
#
# Build with: cargo build --release --features persistence
# Run with:   ./target/release/df_engine --pipeline configs/otlp-persistence-debug.yaml
# Send data:  telemetrygen logs --otlp-endpoint localhost:4317 --otlp-insecure --logs 10
# Verify:     cat /tmp/persistence_debug.log

settings:
  default_pipeline_ctrl_msg_channel_size: 100
  default_node_ctrl_msg_channel_size: 100
  default_pdata_channel_size: 100

nodes:
  receiver:
    kind: receiver
    plugin_urn: "urn:otel:otlp:receiver"
    out_ports:
      out_port:
        destinations:
          - persistence
        dispatch_strategy: round_robin
    config:
      listening_addr: "127.0.0.1:4317"

  persistence:
    kind: processor
    plugin_urn: "urn:otap:processor:persistence"
    out_ports:
      out_port:
        destinations:
          - debug
        dispatch_strategy: round_robin
    config:
      path: /tmp/quiver_test
      poll_interval: 100ms
      retention_size_cap: "1GB"
      size_cap_policy: backpressure
      # Convert to Arrow so debug processor can display the data
      otlp_handling: convert_to_arrow

  debug:
    kind: processor
    plugin_urn: "urn:otel:debug:processor"
    out_ports:
      out_port:
        destinations:
          - noop
        dispatch_strategy: round_robin
    config:
      verbosity: detailed
      output: /tmp/persistence_debug.log

  noop:
    kind: exporter
    plugin_urn: "urn:otel:noop:exporter"
