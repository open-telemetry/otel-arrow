settings:
  default_pipeline_ctrl_msg_channel_size: 100
  default_node_ctrl_msg_channel_size: 100
  default_pdata_channel_size: 100

nodes:
  generator:
    kind: receiver
    plugin_urn: "urn:otel:otap:fake_data_generator:receiver"
    out_ports:
      out_port:
        destinations:
 #         - noop
          - azure-monitor-exporter
        dispatch_strategy: round_robin
    config:
      traffic_config:
        max_signal_count: 100000
        max_batch_size: 1000
        signals_per_second: 1000
        log_weight: 100
      registry_path: https://github.com/open-telemetry/semantic-conventions.git[model]
#  noop:
#    kind: exporter
#    plugin_urn: "urn:otel:noop:exporter"
#    config: {}

  azure-monitor-exporter:
    kind: exporter
    plugin_urn: "urn:otel:azuremonitor:exporter"
    config:
      # API configuration - Update with your actual values
      api:
        dcr_endpoint: "https://my-workspace.eastus-1.ingest.monitor.azure.com"
        stream_name: "Custom-MyTable_CL"
        dcr: "dcr-abc123"
        schema:
          resource_mapping:
            "service.name": "ServiceName"
            "service.version": "ServiceVersion"
            "k8s.pod.name": "PodName"
            "k8s.namespace.name": "Namespace"
            "k8s.deployment.name": "Deployment"
            "k8s.node.name": "NodeName"
          scope_mapping:
            "otel.library.name": "InstrumentationLibrary"
            "otel.library.version": "InstrumentationVersion"
          log_record_mapping:
            "body": "Message"
            "severity_text": "SeverityText"
            "severity_number": "SeverityNumber"
            "time_unix_nano": "TimeGenerated"
            "attributes": "Properties"
            "trace_id": "TraceId"
            "span_id": "SpanId"

      # Authentication configuration for AKS
      auth:
        # Use managed identity for AKS workloads
        method: "managedidentity"  # or "msi"

        # For user-assigned managed identity (common in AKS)
        # Get this from your AKS managed identity configuration
        client_id: "YOUR-USER-ASSIGNED-IDENTITY-CLIENT-ID"

        # For system-assigned managed identity (less common in AKS)
        # Comment out the client_id field above

        # OAuth scope for Azure Monitor
        scope: "https://monitor.azure.com/.default"

# Internal telemetry pipeline - separate from main pipeline
# Uses hardcoded settings: single thread, no admin server
internal:
  telemetry:
    kind: receiver
    plugin_urn: "urn:otel:internal_telemetry:receiver"
    out_ports:
      out_port:
        destinations:
          - kql
        dispatch_strategy: round_robin
    config: {}

  kql:
    kind: processor
    plugin_urn: "urn:otel:recordset_kql:processor"
    out_ports:
      out_port:
        destinations:
          - otlp
        dispatch_strategy: round_robin
    config:
      query: |
        source
        | extend Body = case(
            EventName == "otap-df-otap::rate_limit.sleep (crates/otap/src/fake_data_generator.rs:354)",
            strcat(Body, ". Troubleshooting resource errors: https://docs.example.com/exporter-errors#kql-processor"),
            Body
        )

  otlp:
    kind: exporter
    plugin_urn: "urn:otel:otlp:exporter"
    config:
      grpc_endpoint: "http://127.0.0.1:43480"

service:
  telemetry:
    logs:
      level: "debug"
      providers:
        global: its
        engine: its
        internal: console_direct
        admin: its
    resource:
      service.id: 1234
      service.name: test
