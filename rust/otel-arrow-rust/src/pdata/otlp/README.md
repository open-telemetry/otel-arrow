# OTLP pipeline data

Status: **Development**

This package resembles the OpenTelemetry Collector "pdata" interface,
but for Rust.  This package defines an OTLP pipeline data interface
based on prost::Message objects

For each OTLP message object, builder methods are generated through
the `./derive` sub-crate in this directory. We define two approaches
to building objects, depending on whether they are simple types and
containers (<= 3 fields) compared with detailed protocol objects (>3 fields):

1. Simple types and containers: use `Type::new(...)` with 1-3 parameters
2. Detailed protocol objects: use `Type::build().field(value).finish()`.

There are cases where the builder pattern is not used because all
fields are specified as parameters.

A special case is supported for ignoring certain arguments in simple
types when they are rarely used in OpenTelemetry. Currently, six
"schema_url" fields are in this category; these "ignored" fields have
a special setter derived instead of requiring a parameter in every
`new()` statement.

There are several structs that contain a `oneof` field. Note that
there are not more than one oneof field per struct. The `AnyValue`
type distinguishes the oneof in its constructors (e.g., `new_string`,
`new_int`, ...). The `Metric`, `NumberDataPoint`, and `Exemplar` types
use the all use `build()` with oneof variants expressed through the
particular field (e.g., `data_sum`, `data_gauge`, ...).

## List of types

### Simple types

These all have `new(...)` constructor methods. For a constructor with
a oneof, the type is used in the name as in `new_variant(...)`.

In `crate::proto::opentelemetry::common::v1`:

- AnyValue: Oneof (`string`, `int`, `double`, `bool`, `array`, `kvlist`)
- KeyValue: Key, Value
- KeyValueList: Value
- ArrayValue: Value

In `crate::proto::opentelemetry::logs::v1`:

- LogsData: ResourceLogs
- ResourceLogs: Resource, ScopeLogs
- ScopeLogs: Scope, Records

In `crate::proto::opentelemetry::trace::v1`:

- TracesData: ResourceSpans
- ResourceSpans: Resource, ScopeSpans
- ScopeSpans: Scope, Spans
- Status: Code, Message

In `crate::proto::opentelemetry::metrics::v1`:

- MetricsData: ResourceMetrics
- ResourceMetrics: Resource, ScopeMetrics
- ScopeMetrics: Scope, Metrics
- Sum: AggregationTemporality, Monotonic, DataPoints
- Gauge: DataPoints
- Histogram: AggregationTemporality, DataPoints
- ExponentialHistogram: AggregationTemporality, DataPoints
- Summary: DataPoints
- Buckets: Offset, BucketCounts
- ValueAtQuantile: Quantile, Value

All structs are simple for the OTLP request and response types defined
in `crate::proto::opentelemetry::collector::*::v1`.

Note: several types define `fn set_schema_url(self, ...) -> Self` for
setting the ignored `schema_url` field in the resource and scope
containers.

## Example generated code

See the [tests](./tests.rs) for examples of the resulting syntax.

The file `model/src/lib.rs` defines how each message type is treated
in a `REQUIRED_PARAMS` map.

Use `cargo expand` to see the full macro derivation.

### Example derived code: simple type

The `TracesData` message object derives the following code, for example:

```rust
    // Type generated by Prost
    pub struct TracesData {
        #[prost(message, repeated, tag = "1")]
        pub resource_spans: ::prost::alloc::vec::Vec<ResourceSpans>,
    }
    //
    // Methods inserted by
    // #[derive(Clone, Default, prost::Message, ...)]
    //
    // Methods inserted by this code:
    impl TracesData {
        pub fn new<T1: Into<::prost::alloc::vec::Vec<ResourceSpans>>>(
            resource_spans: T1,
        ) -> Self {
            Self {
                resource_spans: resource_spans.into(),
            }
        }
    }
```

### Example derived code: detail object

The `Span` message object derives the following code, for example:

```rust
    impl Span {
        pub fn build() -> SpanBuilder {
            SpanBuilder {
                inner: Self {
                    // ... defaults ...
                },
            }
        }
    }
    pub struct SpanBuilder {
        inner: Span,
    }
    impl SpanBuilder {
        pub fn trace_id<T: Into<::prost::alloc::vec::Vec<u8>>>(
            mut self,
            trace_id: T,
        ) -> Self {
            self.inner.trace_id = trace_id.into();
            self
        }
        //
        // ... one method per field
        //
        pub fn finish(self) -> Span {
            self.inner
        }
    }
    impl std::convert::From<SpanBuilder> for Span {
        fn from(builder: SpanBuilder) -> Self {
            builder.finish()
        }
    }
```
