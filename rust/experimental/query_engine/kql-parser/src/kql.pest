// TODO put the comments back


summarize_expression = {
    "summarize"
        ~ (aggregate_expression ~ ("," ~ aggregate_expression)*)?
        ~ ("by" ~ group_by_expression ~ ("," ~ group_by_expression)*)?
        ~ ("|" ~ tabular_expressions)*
}


tabular_expressions = _{
    extend_expression
    | project_expression
    | project_keep_expression
    | project_away_expression
    | project_rename_expression
    | where_expression
    | summarize_expression
}

tabular_expression = {
    identifier_literal ~ ("|" ~ tabular_expressions)*
}

user_defined_function_parameter_definition_expression = {
	identifier_literal
    ~ ":"
    ~ (
    	(type_literal ~ ("=" ~ scalar_expression)?)
        | user_defined_function_tabular_parameter_definition_expression
      )
}

user_defined_function_tabular_parameter_definition_expression = {
	"("
    ~ (
    	"*"
        | (identifier_literal ~ ":" ~ type_literal ~ ("," ~ identifier_literal ~ ":" ~ type_literal)*)
      )
    ~ ")"
}

user_defined_function_body_definition_expression = {
    (user_defined_function_expressions ~ (";" ~ user_defined_function_expressions)* ~ ";")?
    ~ (scalar_expression)?
    ~ ";"?
}

user_defined_function_expressions = _{
	variable_definition_expression
}

user_defined_function_definition_expression = {
	"let" ~ identifier_literal ~ "=" ~ "("
    ~ (user_defined_function_parameter_definition_expression ~ ("," ~ user_defined_function_parameter_definition_expression)*)?
    ~ ")"
    ~ "{" ~ user_defined_function_body_definition_expression ~ "}"
}

query_expressions = _{
    variable_definition_expression|user_defined_function_definition_expression|tabular_expression
}

query = {
    SOI ~ (query_expressions ~ (";" ~ query_expressions)* ~ ";"?)? ~ EOI
}