# This action runs the pipeline perf continuous benchmarking suite on every PR.
# - With 'pipelineperf' label: runs on dedicated Oracle bare-metal hardware for accurate benchmarks
# - Without label: runs on ubuntu-latest for basic validation
# In either case, the results does not update the charts.
name: Pipeline Perf Pre-Merge

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

# Cancel in-progress runs for the same PR if a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Check for the pipelineperf label to determine which runner to use
  label-check:
    name: Check for pipelineperf label
    runs-on: ubuntu-latest
    outputs:
      has_label: ${{ steps.check_label.outputs.has_label }}
    steps:
      - name: Check if PR has 'pipelineperf' label
        id: check_label
        run: |
          labels=$(echo '${{ toJson(github.event.pull_request.labels) }}' | jq -r '.[].name')
          if echo "$labels" | grep -q "pipelineperf"; then
            echo "Label pipelineperf found - will use dedicated hardware"
            echo "has_label=true" >> $GITHUB_OUTPUT
          else
            echo "Label 'pipelineperf' not found - will use ubuntu-latest"
            echo "has_label=false" >> $GITHUB_OUTPUT
          fi

  # Run on dedicated Oracle hardware when 'pipelineperf' label is present
  pipeline-perf-test-dedicated:
    needs: label-check
    if: needs.label-check.outputs.has_label == 'true'
    runs-on: oracle-bare-metal-64cpu-512gb-x86-64
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - id: detect_os
        name: Detect OS (self-hosted)
        shell: bash
        run: |
          . /etc/os-release
          echo "id=$ID" >> "$GITHUB_OUTPUT"
          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"

      - name: Install/prepare Python 3.11 on Oracle Linux 8 (self-hosted only)
        if: ${{ runner.os == 'Linux' && steps.detect_os.outputs.id == 'ol' && startsWith(steps.detect_os.outputs.version_id, '8') }}
        shell: bash
        run: |
          set -euxo pipefail

          # Run disk cleanup script
          bash ./.github/workflows/scripts/disk-cleanup.sh

          sudo dnf -y install oracle-epel-release-el8 || true
          sudo dnf -y config-manager --set-enabled ol8_codeready_builder || true
          sudo dnf -y makecache
          sudo dnf -y install python3.11 python3.11-devel || true
          if ! /usr/bin/python3.11 -m pip --version >/dev/null 2>&1; then
            /usr/bin/python3.11 -m ensurepip --upgrade || true
          fi
          /usr/bin/python3.11 -m pip install --upgrade pip setuptools wheel || true
          mkdir -p "$HOME/.local/bin"
          ln -sf /usr/bin/python3.11 "$HOME/.local/bin/python"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          python --version
          python -m pip --version

      - name: Build dataflow_engine
        run: |
          git submodule init
          git submodule update
          cd rust/otap-dataflow
          docker build --build-context otel-arrow=../../ -f Dockerfile -t df_engine .
          cd ../..

      - name: Install dependencies
        run: |
          python -m pip install --user --upgrade pip
          pip install --user -r tools/pipeline_perf_test/orchestrator/requirements.txt
          pip install --user -r tools/pipeline_perf_test/load_generator/requirements.txt

      - name: Run pipeline performance test suite
        run: |
          cd tools/pipeline_perf_test
          python orchestrator/run_orchestrator.py --debug --config test_suites/integration/continuous/100klrps-docker.yaml

  # Run on ubuntu-latest for basic validation when no label is present
  pipeline-perf-test-basic:
    needs: label-check
    if: needs.label-check.outputs.has_label == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build dataflow_engine
        run: |
          git submodule init
          git submodule update
          cd rust/otap-dataflow
          docker build --build-context otel-arrow=../../ -f Dockerfile -t df_engine .
          cd ../..

      - name: Install dependencies
        run: |
          python -m pip install --user --upgrade pip
          pip install --user -r tools/pipeline_perf_test/orchestrator/requirements.txt
          pip install --user -r tools/pipeline_perf_test/load_generator/requirements.txt

      - name: Run pipeline performance test suite
        run: |
          cd tools/pipeline_perf_test
          python orchestrator/run_orchestrator.py --debug --config test_suites/integration/continuous/100klrps-docker.yaml

